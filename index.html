<!DOCTYPE html>

<html>
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>FIND PLASMA DONOR</title>


  <!-- semantic -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" integrity="sha256-9mbkOfVho3ZPXfM7W8sV2SndrGDuh7wuyLjtsWeTI1Q=" crossorigin="anonymous" />
  
  <!-- leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="anonymous" />

  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <!-- semantic -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js" integrity="sha256-t8GepnyPmw9t+foMh3mKNvcorqNHamSKtKRxxpUEgFI=" crossorigin="anonymous"></script>

  <!-- leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin="anonymous"></script>

  <!-- google autocomplete   -->
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEsEJdLLF-NAvcX3FLw0DfnJjTt-lLr4Y&sensor=false&libraries=places"></script>

 <style type="text/css">

  body {
    background-color: #FFFFFF;
  }
  .main.container {
    margin-top: 2em;
  }

  .main.menu {
    margin-top: 4em;
    border-radius: 0;
    border: none;
    box-shadow: none;
    transition:
      box-shadow 0.5s ease,
      padding 0.5s ease
    ;
  }
  .main.menu .item img.logo {
    margin-right: 1.5em;
  }

  .overlay {
    float: left;
    margin: 0em 3em 1em 0em;
  }
  .overlay .menu {
    position: relative;
    left: 0;
    transition: left 0.5s ease;
  }

  .main.menu.fixed {
    background-color: #FFFFFF;
    border: 1px solid #DDD;
    box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.2);
  }
  .overlay.fixed .menu {
    left: 800px;
  }

  .text.container .left.floated.image {
    margin: 2em 2em 2em -4em;
  }
  .text.container .right.floated.image {
    margin: 2em -4em 2em 2em;
  }

  .ui.footer.segment {
    margin: 5em 0em 0em;
    padding: 5em 0em;
  }

  #map {
	width: 100%;
	height: 800px;
}

  </style>

</head>





<body>

    <div class='ui main container'>




                <div class="ui grid">
                    <div class="row">

                <div class="column">

                    <div class="ui breadcrumb">
                        <h2><a class="active section" href="#"> Home</a> </h2>
                       
                    </div>
                </div>

                <div class="right floated column">
                    <!-- <form action="register/" method = "get"> -->
                       <h3> <button class='large right floated' id='reg'>Register</button> </h3>
                        <div class="ui modal reg">

                                <form class="ui form segment" id='form1'>

                                    <p>Tell Us About Yourself</p>
                                
                                    <div class="field">
                                
                                      <label>Are you a Plasma Donor or Receiver?</label>
                                
                                      <select class="ui dropdown" name="donor_type">
                                
                                        <option value="">Type</option>
                                        <option value="Donors">Donor</option>
                                        <option value="Recievers">Reciever</option>
                                      </select>
                                    </div>
                                
                                      <div class="field">
                                
                                        <label>Contact</label>
                                
                                        <input placeholder="Add Contact Details" name="contact" type="number">
                                
                                      </div>
                                
                                      
                                
                                      <div class="field">
                                
                                        <label>Gender</label>
                                
                                        <select class="ui dropdown" name="gender">
                                
                                          <option value="">Gender</option>
                                          <option value="male">Male</option>
                                          <option value="female">Female</option>
                                        </select>
                                      </div>
                                
                                      
                                      <div class="field">
                                
                                        <label>Blood Type</label>
                                
                                        <select class="ui dropdown" name="blood_group">
                                
                                          <option value="">Blood Group</option>
                                          <option value="O+">O +</option>
                                          <option value="O-">O - </option>
                                        </select>
                                      </div>
                                
                                
                                    <div class="field">
                                      <label>Address</label>
                                      <input placeholder="Flat/Street Address/Landmark" name="username" type="text">
                                    </div>
                                   
                                    <div class="field">
                                      <label for="locationTextField">Location</label>
                                      <input id="locationTextField" name = 'location' type="text" size="50">
                                    </div>
                                
                                
                                
                                    <div class="inline field">
                                      <div class="ui checkbox">
                                        <input type="checkbox" name="terms">
                                        <label>I agree to the terms and conditions</label>
                                      </div>
                                    </div>
                                    <div class="ui blue submit button">Submit</div>
                                    <div class="ui error message"></div>
                                
                                  </form>

                             
                            </div>
                        </div>   

                    </form>   
                </div>
            </div>



            <div class = 'ui segment '>


                <div class="ui four column centered grid">
                    <div class="row">
                        <h1 class="ui header">FIND COVID PLASMA DONOR</h1>
                    </div>

                </div>

                <div class="ui relaxed grid ">

                    <div class="four wide column">
                        <div class="row">
                                <div class="ui sub header">FIlter   </div>
                                    <select
                                    id = 'donor_type' class="ui search fluid dropdown multiple" autocomplete ='off' multiple = ''></select>
                        </div>

                        <br>
                        <div class="row">
                                <div class="ui sub header">Select Blood Group</div>
                                    <select
                                    id = 'blood_type' class="ui search fluid dropdown" autocomplete ='off' multiple = ''>
                                          <option value="">Blood Group</option>
                                          <option value="O+">O +</option>
                                          <option value="O-">O - </option>
                                </select>

                        </div>
                        <br>
                        <div class="row">
                                <div class="ui sub header">City</div>
                                    <select
                                    id = 'city' class="ui search fluid dropdown multiple" autocomplete ='off' multiple = ''></select>

                        </div>


                    </div>



                        <div class="twelve wide column">
                            <div class="row">
                                <div id = 'map-container'>
                                    <div id='map'></div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>




    </div> <!-- Container End -->
    </div>

    <br>
    <br>

    <script>

    //init the code

    $( document ).ready(function() {
   
        //Modal View

        
    $(function(){
      $("#reg").click(function(){
        $(".reg").modal('show');
      });
      $(".reg").modal({
        closable: true
      });
    });


        //Main Function
            var list_of_tabs_tbody = ['po',]
            //Init dropdowns
            var list_of_dropdowns = ['blood_type','donor_type', 'status','segment','bandwidth','po_number', 'circuit'];

            for(let i in list_of_dropdowns)
            {
                $('#' + list_of_dropdowns[i]).dropdown('');
                //	$('#' + list_of_dropdowns[i]).parent().addClass('loading');

            }

            //Init map

            //Define Map
            var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

            var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox/light-v9', attribution: mbAttr}),
            streets  = L.tileLayer(mbUrl, {id: 'mapbox/streets-v11',   attribution: mbAttr});

            var logical = L.layerGroup();
            var physical = L.layerGroup();

           
            var map = L.map('map', {
                center: [20.5937, 78.9629],
                zoom: 6,
                layers: [grayscale, physical],
                collapsed:false,
                fullscreenControl: {
                    pseudoFullscreen: true},
                    doubleClickZoom:true,
                dragging:true,
                trackResize	:true,
                inertia: true,
                keyboard: true,
                tap: true,
                fadeAnimation: true,
                zoomAnimation	:true,
                markerZoomAnimation:true,
                inertiaDeceleration: 3000,
                easeLinearity: 0.2,
            });
            
           
            var blood_donor = L.icon({
                iconUrl: "/img/blood_donor_transparent.png",
                // shadowUrl: 'leaf-shadow.png',

                iconSize:     [22, 24], // size of the icon
                shadowSize:   [50, 64], // size of the shadow
                iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62],  // the same for the shadow
                popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
            });
            var blood_receiver = L.icon({
                iconUrl: "/img/blood_receiver.png",
                // shadowUrl: 'leaf-shadow.png',

                iconSize:     [45, 35], // size of the icon
                shadowSize:   [50, 64], // size of the shadow
                iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62],  // the same for the shadow
                popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
            });
            
		getData()

		function update_city_a(data)
		{
			$('#city').parent().addClass('loading');
			$('#city').dropdown('clear');
			$('#city').empty();
			let content = [];
			let city_a = [];
			let city_a_sorted = [];
			for(let i in data)
			{
		 	city_a.push(data[i].city);
			}
			city_a_sorted = [...new Set(city_a)].sort();

			for(let i in city_a_sorted){
				content.push('<option value="'+ city_a_sorted[i] +'">'+ city_a_sorted[i] +'</option>');
			}
			$('#city').html(content.join(''));
			console.log('city a updated');
			$('#city').parent().removeClass('loading');

		}

		function update_donor_type(data)
		{
			$('#donor_type').parent().addClass('loading');
			$('#donor_type').dropdown('clear');
			$('#donor_type').empty();
			let content = [];
			let donor_type = [];
			let donor_type_sorted = [];
			for(let i in data)
			{
			donor_type.push(data[i].donor_type);
			}
			donor_type_sorted = [...new Set(donor_type)].sort();

			for(let i in donor_type_sorted){
				content.push('<option value="'+ donor_type_sorted[i] +'">'+ donor_type_sorted[i] +'</option>');
			}
			$('#donor_type').html(content.join(''));
			console.log('donor_type a updated');
			$('#donor_type').parent().removeClass('loading');

		}

		function update_blood_type(data)
		{
			$('#blood_type').parent().addClass('loading');
			$('#blood_type').dropdown('clear');
			$('#blood_type').empty();
			let content = [];
			let blood_type = [];
			let blood_type_sorted = [];
			for(let i in data)
			{
		 	blood_type.push(data[i].blood_group);
			}
			blood_type_sorted = [...new Set(blood_type)].sort();

			for(let i in blood_type_sorted){
				content.push('<option value="'+ blood_type_sorted[i] +'">'+ blood_type_sorted[i] +'</option>');
			}
			$('#blood_type').html(content.join(''));
			console.log('city a updated');
			$('#blood_type').parent().removeClass('loading');

		}


		async function getData(){
			const responses = await fetch('/data');
			const data =  await responses.json();
			console.log(data.lat);
			update_city_a(data)
			update_donor_type(data)
			update_blood_type(data)
            

            //init map markers
            
            for( i in data){

                console.log(data[i].lat,data[i].long);
               
 

                    if(data[i].donor_type == 'Donors'){
                        const marker = L.marker([data[i].lat, data[i].long],{icon: blood_donor}).addTo(map);
                        marker.bindPopup("<h3> Location: </h3> <h3> " + data[i].location + '</h3>')

                    }
                    else{
                        const marker = L.marker([data[i].lat, data[i].long],{icon: blood_receiver}).addTo(map);
                        marker.bindPopup("<h3> Location: </h3> <h3> " + data[i].location + '</h3>')

                    }    

                    // console.log(data[].long);
                

            }
        

		}


        $('#city_a').change(function(){


            var selected_city_a = [];
            var selected_country = [];
            $.each($("#city_a option:selected"), function(){
                selected_city_a.push($(this).val());
            });
                $.each($("#country option:selected"), function(){
                selected_country.push($(this).val());
            });
            var filtered_data = data.filter(el => ((selected_city_a.indexOf(el.A_end_site_City) >= 0 ||
            selected_city_a.indexOf(el.B_end_site_City) >= 0 || selected_city_a == '')
            && (selected_country.indexOf(el.A_end_site_Country) >= 0 ||
            selected_country.indexOf(el.B_end_site_Country) >= 0 || selected_country == '')  ))


            update_bandwidth(filtered_data);


            });


	

    
var autocomplete = '';
  function init() {
                var input = document.getElementById('locationTextField');
                 autocomplete = new google.maps.places.Autocomplete(input,{
                  componentRestriction: {'country': ['in']}, 
                  fields: ['geometry','name'],
                  types:['geocode']


                });
                autocomplete.setComponentRestrictions({
    country: ["in"],
  });
            }

  google.maps.event.addDomListener(window, 'load', init);
            
            
  $( ".ui.form" ).form({
    fields: {
      contact: {
            identifier : "contact",
            rules: [{
                type : "length[2]",
                prompt : 'Enter valid Mobile info'

            }]
        },
        donor: {
            identifier : "donor_type",
            rules: [{
                type : "empty"
            }]
        },
        username: {
            identifier : "username",
            rules: [{
                type : "empty"
            }]
        },
        gender: {
            identifier : "gender",
            rules: [{
                type : "empty"
            }]
        },
        blood: {
            identifier : "blood_group",
            rules: [{
                type : "empty"
            }]
        },
        location: {
            identifier : "location",
            rules: [{
                type : "empty"
            }]
        },
        checkbox: {
            identifier : "terms",
            rules: [{
                type : "checked"
            }]
        },
      password: {
          identifier : 'password',
          inline : true,
          on     : 'blur',
          rules: [
          {
          type   : 'empty',
          prompt : 'Please enter a password'
        },
        {
          type   : 'length[6]',
          prompt : 'Your password must be at least 6 characters'
        }
      ]
    },
    },
    inline :true,
    on: 'blur',
    transition: 'fade down',
    onSuccess: function() 
    {
       
        //get lat long of location

        const place = autocomplete.getPlace();
        console.log(place);
        const lat = place.geometry.location.lat();
        const lon = place.geometry.location.lng();


        let $form = $('.ui.form');
        // get all values
        let allFields = $form.form('get values');

        const geo_location = $('#locationTextField').val();
        let area = geo_location.split(",")[0]; 
        let city = geo_location.split(",")[1]; 
        let country = geo_location.split(",")[2]; 
      

        allFields.lat = lat;
        allFields.long = lon;
        allFields.area = area;
        allFields.country = country;
        allFields.city = city;


       // Find our form in the DOM using its class name.
        // var data = $("#form1").serialize();// Get the form data with our (yet to be defined) function.
        const options ={
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        // 'Content-Type': 'application/x-www-form-urlencoded',
      },
        body: JSON.stringify(allFields) // body data type must match "Content-Type" header
      }

        fetch('/api',options)
        .then(response  => {
        // //   response.html().then(val =>
        // //   {
           console.log(response);
        //    alert('Form submitted Successfully');
           $(".reg").modal('hide');
           getData();

        // //     console.log(val);
        // //     //  window.location.href('localhost:3000/index.html');
        //       alert('Form Successfully Submuted')
              //  window.location = "/success"
        // //   });
        // //  });
        
        });

       
    }
}).submit( function( e ) {
    e.preventDefault();


});
});


</script>